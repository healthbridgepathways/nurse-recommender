import React, { useState } from 'react';
import { ChevronRight, MapPin, Clock, DollarSign, BookOpen, Users, Star } from 'lucide-react';

const NurseRecommenderTool = () => {
  const [currentStep, setCurrentStep] = useState(0);
  const [answers, setAnswers] = useState({});
  const [recommendations, setRecommendations] = useState(null);

  const questions = [
    {
      id: 'qualification',
      title: 'What is your highest nursing qualification?',
      type: 'select',
      options: [
        { value: 'diploma', label: 'Diploma in Nursing' },
        { value: 'bachelor', label: "Bachelor's Degree in Nursing" },
        { value: 'master', label: "Master's Degree in Nursing" },
        { value: 'doctorate', label: 'Doctorate in Nursing' }
      ]
    },
    {
      id: 'experience',
      title: 'How many years of clinical nursing experience do you have?',
      type: 'select',
      options: [
        { value: 'none', label: 'New graduate (0-6 months)' },
        { value: 'less1', label: 'Less than 1 year' },
        { value: '1-3', label: '1-3 years' },
        { value: '3-5', label: '3-5 years' },
        { value: '5plus', label: '5+ years' }
      ]
    },
    {
      id: 'currentCountry',
      title: 'Where did you complete your nursing education?',
      type: 'select',
      options: [
        { value: 'philippines', label: 'Philippines' },
        { value: 'india', label: 'India' },
        { value: 'nigeria', label: 'Nigeria' },
        { value: 'uk', label: 'United Kingdom' },
        { value: 'canada', label: 'Canada' },
        { value: 'usa', label: 'United States' },
        { value: 'other', label: 'Other country' }
      ]
    },
    {
      id: 'englishTest',
      title: 'What are your English test scores?',
      type: 'english',
      tests: ['IELTS', 'OET', 'TOEFL', 'PTE', 'Not taken yet']
    },
    {
      id: 'priority',
      title: 'What is your main priority?',
      type: 'select',
      options: [
        { value: 'speed', label: 'Fastest pathway to licensure' },
        { value: 'cost', label: 'Most cost-effective option' },
        { value: 'income', label: 'Highest earning potential' },
        { value: 'immigration', label: 'Best immigration opportunities' },
        { value: 'ease', label: 'Simplest process' }
      ]
    },
    {
      id: 'examWillingness',
      title: 'Are you willing to take additional practical exams (OSCE)?',
      type: 'boolean',
      options: [
        { value: true, label: 'Yes, I am prepared for practical exams' },
        { value: false, label: 'I prefer written/computer-based exams only' }
      ]
    },
    {
      id: 'countryPreference',
      title: 'Do you have any country preferences?',
      type: 'multi-select',
      options: [
        { value: 'canada', label: 'Canada' },
        { value: 'usa', label: 'United States' },
        { value: 'uk', label: 'United Kingdom' },
        { value: 'australia', label: 'Australia' },
        { value: 'newzealand', label: 'New Zealand' },
        { value: 'no_preference', label: 'No preference - show me all options' }
      ]
    }
  ];

  const handleAnswer = (questionId, answer) => {
    setAnswers(prev => ({ ...prev, [questionId]: answer }));
  };

  const nextStep = () => {
    if (currentStep < questions.length - 1) {
      setCurrentStep(currentStep + 1);
    } else {
      generateRecommendations();
    }
  };

  const prevStep = () => {
    if (currentStep > 0) {
      setCurrentStep(currentStep - 1);
    }
  };

  const generateRecommendations = () => {
    const profile = answers;
    const recs = [];

    // Scoring system based on user profile
    const countryScores = {
      canada: { score: 0, provinces: [] },
      usa: { score: 0, states: [] },
      uk: { score: 0 },
      australia: { score: 0 },
      newzealand: { score: 0 }
    };

    // Priority-based scoring
    if (profile.priority === 'speed') {
      countryScores.uk.score += 30;
      countryScores.usa.score += 25;
      countryScores.canada.score += 15;
      countryScores.australia.score += 10;
      countryScores.newzealand.score += 20;
    } else if (profile.priority === 'cost') {
      countryScores.uk.score += 30;
      countryScores.usa.score += 20;
      countryScores.canada.score += 15;
      countryScores.australia.score += 10;
      countryScores.newzealand.score += 15;
    } else if (profile.priority === 'income') {
      countryScores.usa.score += 30;
      countryScores.canada.score += 25;
      countryScores.australia.score += 20;
      countryScores.uk.score += 15;
      countryScores.newzealand.score += 15;
    } else if (profile.priority === 'immigration') {
      countryScores.canada.score += 30;
      countryScores.australia.score += 25;
      countryScores.newzealand.score += 20;
      countryScores.uk.score += 10;
      countryScores.usa.score += 5;
    } else if (profile.priority === 'ease') {
      countryScores.uk.score += 25;
      countryScores.usa.score += 20;
      countryScores.canada.score += 15;
      countryScores.newzealand.score += 15;
      countryScores.australia.score += 10;
    }

    // Experience-based adjustments
    if (profile.experience === 'none' || profile.experience === 'less1') {
      countryScores.canada.score += 10; // Good bridging programs
      countryScores.uk.score += 5;
    } else if (profile.experience === '5plus') {
      countryScores.usa.score += 10;
      countryScores.australia.score += 5;
    }

    // OSCE willingness
    if (profile.examWillingness === false) {
      countryScores.usa.score += 15; // Only NCLEX required
      countryScores.canada.score += 10;
      countryScores.uk.score -= 5; // Requires OSCE
      countryScores.australia.score -= 10; // Requires OSCE
      countryScores.newzealand.score -= 5; // May require OSCE
    }

    // Country preference bonus
    if (profile.countryPreference && !profile.countryPreference.includes('no_preference')) {
      profile.countryPreference.forEach(pref => {
        if (countryScores[pref]) {
          countryScores[pref].score += 20;
        }
      });
    }

    // Add specific provinces/states for ALL Canada and USA recommendations
    if (countryScores.canada.score > 20) { // Lower threshold to catch more recommendations
      if (profile.priority === 'speed') {
        countryScores.canada.provinces = ['Prince Edward Island', 'Alberta', 'British Columbia'];
      } else if (profile.priority === 'cost') {
        countryScores.canada.provinces = ['Prince Edward Island', 'Manitoba', 'Saskatchewan'];
      } else if (profile.priority === 'ease') {
        countryScores.canada.provinces = ['Prince Edward Island', 'Newfoundland', 'Manitoba'];
      } else if (profile.priority === 'immigration') {
        countryScores.canada.provinces = ['Ontario', 'British Columbia', 'Alberta'];
      } else {
        countryScores.canada.provinces = ['Ontario', 'British Columbia'];
      }
    }

    if (countryScores.usa.score > 20) { // Lower threshold to catch more recommendations
      if (profile.priority === 'speed') {
        countryScores.usa.states = ['Florida', 'Georgia', 'New York'];
      } else if (profile.priority === 'cost') {
        countryScores.usa.states = ['Nevada', 'Illinois', 'California'];
      } else if (profile.priority === 'ease') {
        countryScores.usa.states = ['California', 'Nevada', 'Illinois'];
      } else if (profile.priority === 'income') {
        countryScores.usa.states = ['California', 'Texas', 'New York'];
      } else {
        countryScores.usa.states = ['California', 'Texas'];
      }
    }

    // Sort and create recommendations
    const sortedCountries = Object.entries(countryScores)
      .sort(([,a], [,b]) => b.score - a.score)
      .slice(0, 3);

    const countryDetails = {
      canada: {
        name: 'Canada',
        flag: '🇨🇦',
        timeline: '6-24 months',
        cost: '$3,000-$10,000 CAD',
        difficulty: 'Medium-High',
        highlights: ['Excellent immigration pathways', 'Strong healthcare system', 'Multiple provincial options'],
        exam: 'NCLEX-RN'
      },
      usa: {
        name: 'United States',
        flag: '🇺🇸',
        timeline: '4-12 months',
        cost: '$500-$1,500 USD',
        difficulty: 'Medium',
        highlights: ['Highest nursing salaries globally', '50 state options', 'NCLEX-RN only'],
        exam: 'NCLEX-RN'
      },
      uk: {
        name: 'United Kingdom',
        flag: '🇬🇧',
        timeline: '4-9 months',
        cost: '£1,800-£2,500',
        difficulty: 'Medium',
        highlights: ['Fast processing', 'NHS experience', 'Gateway to Europe'],
        exam: 'CBT + OSCE'
      },
      australia: {
        name: 'Australia',
        flag: '🇦🇺',
        timeline: '6-12 months',
        cost: '$3,000-$6,000 AUD',
        difficulty: 'High',
        highlights: ['Strong economy', 'High quality of life', 'Multiple pathways'],
        exam: 'NCLEX-RN + OSCE'
      },
      newzealand: {
        name: 'New Zealand',
        flag: '🇳🇿',
        timeline: '5-10 months',
        cost: '$4,500-$6,500 NZD',
        difficulty: 'Medium',
        highlights: ['Beautiful scenery', 'Work-life balance', 'Cultural competence focus'],
        exam: 'Theory + OSCE'
      }
    };

    sortedCountries.forEach(([country, data], index) => {
      const details = countryDetails[country];
      if (details) {
        recs.push({
          rank: index + 1,
          country: details.name,
          flag: details.flag,
          score: data.score,
          timeline: details.timeline,
          cost: details.cost,
          difficulty: details.difficulty,
          highlights: details.highlights,
          exam: details.exam,
          provinces: data.provinces || [],
          states: data.states || [],
          reasoning: generateReasoning(profile, country, index)
        });
      }
    });

    setRecommendations(recs);
  };

  const generateReasoning = (profile, country, rank) => {
    const reasons = [];
    
    if (country === 'canada' && profile.priority === 'immigration') {
      reasons.push('Express Entry points for healthcare workers');
    }
    if (country === 'usa' && profile.priority === 'income') {
      reasons.push('Highest nursing salaries globally');
    }
    if (country === 'uk' && profile.priority === 'speed') {
      reasons.push('Streamlined 4-stage process');
    }
    if (profile.examWillingness === false && (country === 'usa' || country === 'canada')) {
      reasons.push('No practical OSCE exam required');
    }
    if (profile.experience === 'none' && country === 'canada') {
      reasons.push('Excellent bridging programs for new graduates');
    }

    return reasons.length > 0 ? reasons.join(', ') : 'Good match for your profile';
  };

  const resetTool = () => {
    setCurrentStep(0);
    setAnswers({});
    setRecommendations(null);
  };

  if (recommendations) {
    return (
      <div className="max-w-4xl mx-auto p-6 bg-gradient-to-br from-blue-50 to-indigo-100 rounded-xl">
        <div className="text-center mb-8">
          <h2 className="text-3xl font-bold text-gray-800 mb-2">Your Personalized Recommendations</h2>
          <p className="text-gray-600">Based on your profile, here are the best pathways for you:</p>
        </div>

        <div className="space-y-6">
          {recommendations.map((rec) => (
            <div key={rec.rank} className={`p-6 rounded-xl shadow-lg border-l-4 ${
              rec.rank === 1 ? 'bg-green-50 border-green-500' :
              rec.rank === 2 ? 'bg-blue-50 border-blue-500' :
              'bg-purple-50 border-purple-500'
            }`}>
              <div className="flex items-start justify-between mb-4">
                <div className="flex items-center space-x-3">
                  <span className="text-2xl">{rec.flag}</span>
                  <div>
                    <h3 className="text-xl font-bold text-gray-800">
                      {rec.rank === 1 ? '🏆 Top Recommendation: ' : 
                       rec.rank === 2 ? '🥈 Second Choice: ' : 
                       '🥉 Third Option: '}
                      {rec.country}
                    </h3>
                    <p className="text-gray-600 text-sm">{rec.reasoning}</p>
                  </div>
                </div>
                <div className="text-right">
                  <div className="flex items-center space-x-1">
                    {[...Array(5)].map((_, i) => (
                      <Star key={i} className={`w-4 h-4 ${
                        i < Math.floor(rec.score / 20) ? 'text-yellow-400 fill-current' : 'text-gray-300'
                      }`} />
                    ))}
                  </div>
                  <span className="text-xs text-gray-500">Match Score</span>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div className="flex items-center space-x-2">
                  <Clock className="w-5 h-5 text-blue-600" />
                  <div>
                    <div className="font-medium text-sm">Timeline</div>
                    <div className="text-xs text-gray-600">{rec.timeline}</div>
                  </div>
                </div>
                <div className="flex items-center space-x-2">
                  <DollarSign className="w-5 h-5 text-green-600" />
                  <div>
                    <div className="font-medium text-sm">Est. Cost</div>
                    <div className="text-xs text-gray-600">{rec.cost}</div>
                  </div>
                </div>
                <div className="flex items-center space-x-2">
                  <BookOpen className="w-5 h-5 text-purple-600" />
                  <div>
                    <div className="font-medium text-sm">Difficulty</div>
                    <div className="text-xs text-gray-600">{rec.difficulty}</div>
                  </div>
                </div>
                <div className="flex items-center space-x-2">
                  <Users className="w-5 h-5 text-orange-600" />
                  <div>
                    <div className="font-medium text-sm">Primary Exam</div>
                    <div className="text-xs text-gray-600">{rec.exam}</div>
                  </div>
                </div>
              </div>

              {(rec.provinces.length > 0 || rec.states.length > 0) && (
                <div className="mb-4">
                  <h4 className="font-medium text-sm mb-2 flex items-center">
                    <MapPin className="w-4 h-4 mr-1" />
                    Recommended {rec.provinces.length > 0 ? 'Provinces' : 'States'}:
                  </h4>
                  <div className="flex flex-wrap gap-2">
                    {(rec.provinces.length > 0 ? rec.provinces : rec.states).map((location) => (
                      <span key={location} className="px-3 py-1 bg-white rounded-full text-xs font-medium text-gray-700 border">
                        {location}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              <div>
                <h4 className="font-medium text-sm mb-2">Key Highlights:</h4>
                <div className="flex flex-wrap gap-2">
                  {rec.highlights.map((highlight, index) => (
                    <span key={index} className="px-2 py-1 bg-white bg-opacity-60 rounded text-xs text-gray-700">
                      • {highlight}
                    </span>
                  ))}
                </div>
              </div>
            </div>
          ))}
        </div>

        <div className="mt-8 p-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl text-white text-center">
          <h3 className="text-xl font-bold mb-2">Ready to Start Your Journey?</h3>
          <p className="mb-4 opacity-90">
            Get detailed guidance, step-by-step pathways, and expert support with HealthBridge Pathways
          </p>
          <div className="flex flex-col sm:flex-row gap-3 justify-center">
            <button className="px-6 py-2 bg-white text-indigo-600 rounded-lg font-medium hover:bg-gray-100 transition-colors">
              Explore Full Pathways
            </button>
            <button 
              onClick={resetTool}
              className="px-6 py-2 border border-white text-white rounded-lg font-medium hover:bg-white hover:text-indigo-600 transition-colors"
            >
              Start New Assessment
            </button>
          </div>
        </div>
      </div>
    );
  }

  const currentQuestion = questions[currentStep];

  return (
    <div className="max-w-2xl mx-auto p-6">
      <div className="mb-8 text-center">
        <h1 className="text-3xl font-bold text-gray-800 mb-2">🏥 Nurse Pathway Recommender</h1>
        <p className="text-gray-600">Find your ideal country for RN licensure</p>
        
        <div className="mt-4 bg-gray-200 rounded-full h-2">
          <div 
            className="bg-gradient-to-r from-blue-500 to-indigo-600 h-2 rounded-full transition-all duration-300"
            style={{ width: `${((currentStep + 1) / questions.length) * 100}%` }}
          ></div>
        </div>
        <p className="text-sm text-gray-500 mt-2">
          Question {currentStep + 1} of {questions.length}
        </p>
      </div>

      <div className="bg-white rounded-xl shadow-lg p-8">
        <h2 className="text-xl font-semibold text-gray-800 mb-6">
          {currentQuestion.title}
        </h2>

        {currentQuestion.type === 'select' && (
          <div className="space-y-3">
            {currentQuestion.options.map((option) => (
              <button
                key={option.value}
                onClick={() => handleAnswer(currentQuestion.id, option.value)}
                className={`w-full p-4 text-left rounded-lg border-2 transition-all hover:border-blue-300 ${
                  answers[currentQuestion.id] === option.value
                    ? 'border-blue-500 bg-blue-50'
                    : 'border-gray-200'
                }`}
              >
                {option.label}
              </button>
            ))}
          </div>
        )}

        {currentQuestion.type === 'boolean' && (
          <div className="space-y-3">
            {currentQuestion.options.map((option) => (
              <button
                key={option.value.toString()}
                onClick={() => handleAnswer(currentQuestion.id, option.value)}
                className={`w-full p-4 text-left rounded-lg border-2 transition-all hover:border-blue-300 ${
                  answers[currentQuestion.id] === option.value
                    ? 'border-blue-500 bg-blue-50'
                    : 'border-gray-200'
                }`}
              >
                {option.label}
              </button>
            ))}
          </div>
        )}

        {currentQuestion.type === 'multi-select' && (
          <div className="space-y-3">
            {currentQuestion.options.map((option) => (
              <button
                key={option.value}
                onClick={() => {
                  const current = answers[currentQuestion.id] || [];
                  let updated;
                  
                  if (option.value === 'no_preference') {
                    updated = current.includes('no_preference') ? [] : ['no_preference'];
                  } else {
                    if (current.includes('no_preference')) {
                      updated = [option.value];
                    } else {
                      updated = current.includes(option.value)
                        ? current.filter(v => v !== option.value)
                        : [...current, option.value];
                    }
                  }
                  
                  handleAnswer(currentQuestion.id, updated);
                }}
                className={`w-full p-4 text-left rounded-lg border-2 transition-all hover:border-blue-300 ${
                  (answers[currentQuestion.id] || []).includes(option.value)
                    ? 'border-blue-500 bg-blue-50'
                    : 'border-gray-200'
                }`}
              >
                <div className="flex items-center">
                  <div className={`w-4 h-4 rounded border mr-3 ${
                    (answers[currentQuestion.id] || []).includes(option.value)
                      ? 'bg-blue-500 border-blue-500'
                      : 'border-gray-300'
                  }`}>
                    {(answers[currentQuestion.id] || []).includes(option.value) && (
                      <div className="w-full h-full flex items-center justify-center">
                        <span className="text-white text-xs">✓</span>
                      </div>
                    )}
                  </div>
                  {option.label}
                </div>
              </button>
            ))}
          </div>
        )}

        {currentQuestion.type === 'english' && (
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Which test have you taken or plan to take?
              </label>
              <select
                className="w-full p-3 border border-gray-300 rounded-lg"
                onChange={(e) => {
                  const current = answers[currentQuestion.id] || {};
                  handleAnswer(currentQuestion.id, { ...current, test: e.target.value });
                }}
                value={answers[currentQuestion.id]?.test || ''}
              >
                <option value="">Select a test</option>
                {currentQuestion.tests.map(test => (
                  <option key={test} value={test}>{test}</option>
                ))}
              </select>
            </div>

            {answers[currentQuestion.id]?.test && answers[currentQuestion.id]?.test !== 'Not taken yet' && (
              <div className="grid grid-cols-2 gap-4">
                {['Reading', 'Writing', 'Speaking', 'Listening'].map(skill => (
                  <div key={skill}>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {skill}
                    </label>
                    <input
                      type="number"
                      step="0.5"
                      className="w-full p-2 border border-gray-300 rounded"
                      placeholder="Score"
                      onChange={(e) => {
                        const current = answers[currentQuestion.id] || {};
                        const scores = current.scores || {};
                        handleAnswer(currentQuestion.id, {
                          ...current,
                          scores: { ...scores, [skill]: e.target.value }
                        });
                      }}
                    />
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        <div className="flex justify-between mt-8">
          <button
            onClick={prevStep}
            disabled={currentStep === 0}
            className="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 transition-colors"
          >
            Previous
          </button>
          
          <button
            onClick={nextStep}
            disabled={!answers[currentQuestion.id]}
            className="px-6 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:from-blue-600 hover:to-indigo-700 transition-all flex items-center space-x-2"
          >
            <span>{currentStep === questions.length - 1 ? 'Get Recommendations' : 'Next'}</span>
            <ChevronRight className="w-4 h-4" />
          </button>
        </div>
      </div>
    </div>
  );
};

export default NurseRecommenderTool;
